/**
 *
 * @name StrangeOrbits
 *
 * @author Sahithyen Kanaganayagam - @sahithyen
 * @version 1.0.1
 *
 * @description Creates a canvas with figures out of points from an image
 *
 * @license GNU GPL v3
 *
 * Copyright (C) 2015 Sahithyen Kanaganayagam (mail@sahithyen.com)
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see <http://www.gnu.org/licenses/>.
 *
 **/

function A(e,t){return 1-3*t+3*e}function B(e,t){return 3*t-6*e}function C(e){return 3*e}function calcBezier(e,t,i){return((A(t,i)*e+B(t,i))*e+C(t))*e}function getSlope(e,t,i){return 3*A(t,i)*e*e+2*B(t,i)*e+C(t)}function binarySubdivide(e,t,i,n,o){var s,r,a=0;do r=t+(i-t)/2,s=calcBezier(r,n,o)-e,s>0?i=r:t=r;while(Math.abs(s)>SUBDIVISION_PRECISION&&++a<SUBDIVISION_MAX_ITERATIONS);return r}function newtonRaphsonIterate(e,t,i,n){for(var o=0;NEWTON_ITERATIONS>o;++o){var s=getSlope(t,i,n);if(0===s)return t;var r=calcBezier(t,i,n)-e;t-=r/s}return t}!function(e){"use strict";"object"==typeof exports?module.exports=e():"function"==typeof define&&define.amd?define("StrangeOrbits",[],e):window.StrangeOrbits=e()}(function(){"use strict";var e=function(e,t){function i(e){var t,i,s;switch(t=u.maxParticleRadius-u.minParticleRadius,this.radius=Math.random()*t+u.minParticleRadius,i=u.maxParticleOpacity-u.minParticleOpacity,this.opacity=Math.random()*i+u.minParticleOpacity,this.offscreen=!1,Math.floor(4*Math.random())){case 0:this.offscreenPosition={x:Math.random()*(n+200)-100,y:-80*Math.random()-20};break;case 1:this.offscreenPosition={x:n+(80*Math.random()+20),y:Math.random()*(o+200)-100};break;case 2:this.offscreenPosition={x:Math.random()*(n+200)-100,y:o+(80*Math.random()+20)};break;case 3:this.offscreenPosition={x:-80*Math.random()-20,y:Math.random()*(o+200)-100}}this.position={x:this.offscreenPosition.x,y:this.offscreenPosition.y},this.previousPosition={x:this.offscreenPosition.x,y:this.offscreenPosition.y},this.nextPosition={x:e.x,y:e.y},this.previousTrembleOffset={x:0,y:0},this.nextTrembleOffset={x:0,y:0},this.mouseOffset={x:0,y:0},s=u.maxTrembleDuration-u.minTrembleDuration,this.trembleDuration=Math.random()*s+u.minTrembleDuration,this.trembleClock=u.maxTrembleDuration}var n,o,s,r,a,f,c,h,u,l=2*Math.PI,d=!0,m={x:null,y:null},p=!1,y=!1,x=[],b=[],g=null,v=null;this.options=u={color:"#FFFFFF",pointDensity:.0075,minParticleRadius:1,maxParticleRadius:3,minParticleOpacity:.15,maxParticleOpacity:.85,minTrembleOffset:10,maxTrembleOffset:20,minTrembleDuration:250,maxTrembleDuration:750,pointForceActivated:!0,pointForceRadius:60,clickedMouseForceActivated:!0,clickedMouseForceRadius:90,animationEasings:{ease:new BezierEasing(.25,.1,.25,1),linear:new BezierEasing(0,0,1,1),"ease-in":new BezierEasing(.42,0,1,1),"ease-out":new BezierEasing(0,0,.58,1),"ease-in-out":new BezierEasing(.42,0,.58,1),strange:new BezierEasing(.7,0,.3,1)}},u.__defineGetter__("backgroundColor",function(){return e.style.backgroundColor}),u.__defineSetter__("backgroundColor",function(t){e.style.backgroundColor=t});var O=function(){if(s=document.createElement("canvas"),e.appendChild(s),r=s.getContext("2d"),a=document.createElement("canvas"),f=a.getContext("2d"),u.backgroundColor="#080808","object"==typeof t)for(var i in t)u[i]=t[i];S(),window.addEventListener("resize",S),e.addEventListener("mousemove",P),e.addEventListener("mousedown",w),e.addEventListener("mouseup",k),e.addEventListener("touchstart",E),e.addEventListener("touchmove",T),e.addEventListener("touchend",I),e.addEventListener("touchcancel",I)};this.start=function(){d=!1,c=Date.now(),h=requestAnimationFrame(M)},this.stop=function(){d=!0},this.showFigure=function(e,t,i,n){b.push({type:"showFigure",clock:0,ready:!1,duration:t,easing:"undefined"==typeof i?"strange":i,callback:n,properties:{url:e}})},this.hideFigure=function(e,t,i){b.push({type:"hideFigure",clock:0,ready:!0,duration:e,easing:"undefined"==typeof t?"strange":t,callback:i})};var S=function(){n=e.offsetWidth,o=e.offsetHeight;var t=window.devicePixelRatio||1,i=r.webkitBackingStorePixelRatio||r.mozBackingStorePixelRatio||r.msBackingStorePixelRatio||r.oBackingStorePixelRatio||r.backingStorePixelRatio||1,a=t/i;s.width=n*a,s.height=o*a,s.style.width=n+"px",s.style.height=o+"px",r.scale(a,a),f.canvas.width=n,f.canvas.height=o,null!==v&&R(v,function(){N()})},P=function(e){y=!0,m.x=e.clientX,m.y=e.clientY},w=function(){p=!0},k=function(){p=!1},T=function(e){m.x=e.changedTouches[0].clientX,m.y=e.changedTouches[0].clientY},E=function(){y=!0},I=function(){y=!1},M=function(){var e,t,i,s,a;for(e=Date.now(),t=e-c,c=e,i=z(t),r.clearRect(0,0,n,o),r.fillStyle=u.color,s=0;s<x.length;s++)x[s].update(i,t),a=x[s],r.beginPath(),r.arc(a.position.x,a.position.y,a.radius,0,l),r.closePath(),r.globalAlpha=a.opacity,r.fill();d||(h=requestAnimationFrame(M))},z=function(e){var t,i,n,o;if(null===g){if(0===b.length)return 1;switch(g=b[0],b.splice(0,1),g.type){case"showFigure":R(g.properties.url,function(){g.ready=!0});break;case"hideFigure":for(v=null,t=0;t<x.length;t++)x[t].setOffset()}"string"==typeof g.easing&&(i=g.easing,g.easing=u.animationEasings[i])}return g.ready?(g.clock+=e,n=g.clock/g.duration,o=g.easing(n),n>=1&&(N(),"function"==typeof g.callback&&g.callback(),g=null),o):1},R=function(e,t){F(e,function(e){var i;i=B(e),A(i,t)})},F=function(e,t){var i;i=new Image,i.onload=function(){"function"==typeof t&&t(i)},v=i.src=e},B=function(e){var t,i,s,r;return i=1,t={width:e.width,height:e.height},i=n/t.width,o/t.height<i&&(i=o/t.height),t={width:i*t.width,height:i*t.height},s={x:n/2-t.width/2,y:o/2-t.height/2},f.clearRect(0,0,n,o),f.drawImage(e,s.x,s.y,t.width,t.height),r=f.getImageData(0,0,n,o),r.data},A=function(e,t){var s,r,a,f,c,h;for(s=3,r=0,f=0;o>f;f++)for(a=0;n>a;a++,s+=4)e[s]>127&&Math.random()<u.pointDensity&&(c={x:a,y:f},"undefined"!=typeof x[r]?x[r].setPosition(c):(h=new i(c),x.push(h)),r++);for(s=r;s<x.length;s++)x[s].setOffset();"function"==typeof t&&t()},N=function(){for(var e=0;e<x.length;e++)x[e].offscreen&&(x.splice(e,1),e--)};i.prototype.setPosition=function(e){this.previousPosition={x:this.nextPosition.x,y:this.nextPosition.y},this.nextPosition={x:e.x,y:e.y}},i.prototype.setOffset=function(){this.previousPosition={x:this.nextPosition.x,y:this.nextPosition.y},this.nextPosition={x:this.offscreenPosition.x,y:this.offscreenPosition.y},this.offscreen=!0},i.prototype.update=function(e,t){var i,n;1>e?(i=this.nextPosition.x-this.previousPosition.x,n=this.nextPosition.y-this.previousPosition.y,this.position={x:this.previousPosition.x+i*e,y:this.previousPosition.y+n*e}):this.position={x:this.nextPosition.x,y:this.nextPosition.y};var o,s,r;if(this.trembleDuration<=this.trembleClock&&(this.trembleClock=0,this.previousTrembleOffset={x:this.nextTrembleOffset.x,y:this.nextTrembleOffset.y},s=u.maxTrembleOffset-u.minTrembleOffset,this.nextTrembleOffset={x:Math.random()*s-u.minTrembleOffset,y:20*Math.random()-10}),i=this.nextTrembleOffset.x-this.previousTrembleOffset.x,n=this.nextTrembleOffset.y-this.previousTrembleOffset.y,this.trembleClock+=t,o=this.trembleClock/this.trembleDuration,r={x:this.previousTrembleOffset.x+i*o,y:this.previousTrembleOffset.y+n*o},this.position={x:this.position.x+r.x,y:this.position.y+r.y},u.pointForceActivated){var a,f,c,h;i=this.position.x-m.x,n=this.position.y-m.y,f=Math.sqrt(Math.pow(i,2)+Math.pow(n,2)),a=p&&u.clickedMouseForceActivated?u.clickedMouseForceRadius:u.pointForceRadius,c=Math.abs(this.mouseOffset.x)>0||Math.abs(this.mouseOffset.y)>0,!y&&c?(this.mouseOffset.x-=.1*this.mouseOffset.x,this.mouseOffset.y-=.1*this.mouseOffset.y):Math.abs(f)<a?(h={x:i/f*a-i,y:n/f*a-n},this.mouseOffset.x+=.1*(h.x-this.mouseOffset.x),this.mouseOffset.y+=.1*(h.y-this.mouseOffset.y)):c&&(this.mouseOffset.x-=.1*this.mouseOffset.x,this.mouseOffset.y-=.1*this.mouseOffset.y),this.position={x:this.position.x+this.mouseOffset.x,y:this.position.y+this.mouseOffset.y}}},O()};return e});var NEWTON_ITERATIONS=4,NEWTON_MIN_SLOPE=.001,SUBDIVISION_PRECISION=1e-7,SUBDIVISION_MAX_ITERATIONS=10,kSplineTableSize=11,kSampleStepSize=1/(kSplineTableSize-1),float32ArraySupported="function"==typeof Float32Array;window.BezierEasing=function(e,t,i,n){function o(t){for(var n=0,o=1,r=kSplineTableSize-1;o!==r&&s[o]<=t;++o)n+=kSampleStepSize;--o;var a=(t-s[o])/(s[o+1]-s[o]),f=n+a*kSampleStepSize,c=getSlope(f,e,i);return c>=NEWTON_MIN_SLOPE?newtonRaphsonIterate(t,f,e,i):0===c?f:binarySubdivide(t,n,n+kSampleStepSize,e,i)}if(!(e>=0&&1>=e&&i>=0&&1>=i))throw new Error("bezier x values must be in [0, 1] range");var s=float32ArraySupported?new Float32Array(kSplineTableSize):new Array(kSplineTableSize);if(e!==t||i!==n)for(var r=0;kSplineTableSize>r;++r)s[r]=calcBezier(r*kSampleStepSize,e,i);return function(s){return e===t&&i===n?s:0===s?0:1===s?1:calcBezier(o(s),t,n)}};
