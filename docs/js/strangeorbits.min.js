/**
 *
 * @name StrangeOrbits
 *
 * @author Sahithyen Kanaganayagam - @sahithyen
 * @version 1.0.1
 *
 * @description Creates a canvas with figures out of points from an image
 *
 * @license GNU GPL v3
 *
 * Copyright (C) 2015 Sahithyen Kanaganayagam (mail@sahithyen.com)
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see <http://www.gnu.org/licenses/>.
 *
 **/

(function(a){if(typeof exports==="object"){module.exports=a()}else{if(typeof define==="function"&&define.amd){define("StrangeOrbits",[],a)}else{window.StrangeOrbits=a()}}})(function(){var a=function(l,k){var d=Math.PI*2;var N=true,o={x:null,y:null,force:1},h=false,I=false,p=[],F=[],D=null,n=null,P,e,m,g,q,M,x,w,E,u;this.options=u={color:"#FFFFFF",pointDensity:0.0075,minParticleRadius:1,maxParticleRadius:3,minParticleOpacity:0.15,maxParticleOpacity:0.85,minTrembleOffset:10,maxTrembleOffset:20,minTrembleDuration:250,maxTrembleDuration:750,pointForceActivated:true,pointForceRadius:60,clickedMouseForceActivated:true,clickedMouseForceRadius:70,animationEasings:{ease:new BezierEasing(0.25,0.1,0.25,1),linear:new BezierEasing(0,0,1,1),"ease-in":new BezierEasing(0.42,0,1,1),"ease-out":new BezierEasing(0,0,0.58,1),"ease-in-out":new BezierEasing(0.42,0,0.58,1),strange:new BezierEasing(0.7,0,0.3,1)}};u.__defineGetter__("backgroundColor",function(){return l.style.backgroundColor});u.__defineSetter__("backgroundColor",function(Q){l.style.backgroundColor=Q});var J=function(){g=document.createElement("canvas");l.appendChild(g);q=g.getContext("2d");M=document.createElement("canvas");x=M.getContext("2d");u.backgroundColor="#080808";if(typeof k==="object"){for(var Q in k){u[Q]=k[Q]}}z();window.addEventListener("resize",z);l.addEventListener("mousemove",G);l.addEventListener("mousedown",L);l.addEventListener("mouseup",v);l.addEventListener("touchstart",t);l.addEventListener("touchmove",O);l.addEventListener("touchend",f);l.addEventListener("touchcancel",f);l.addEventListener("webkitmouseforcewillbegin",s);l.addEventListener("webkitmouseforcedown",K);l.addEventListener("webkitmouseforceup",K);l.addEventListener("webkitmouseforcechanged",K)};this.start=function(){N=false;w=Date.now();E=requestAnimationFrame(b)};this.stop=function(){N=true};this.showFigure=function(R,Q,T,S){F.push({type:"showFigure",clock:0,ready:false,duration:Q,easing:typeof T==="undefined"?"strange":T,callback:S,image:R})};this.hideFigure=function(Q,S,R){F.push({type:"hideFigure",clock:0,ready:true,duration:Q,easing:typeof S==="undefined"?"strange":S,callback:R})};var z=function(){var Q,S,R;e=l.offsetWidth;m=l.offsetHeight;Q=window.devicePixelRatio||1;S=q.webkitBackingStorePixelRatio||q.mozBackingStorePixelRatio||q.msBackingStorePixelRatio||q.oBackingStorePixelRatio||q.backingStorePixelRatio||1;R=Q/S;g.width=e*R;g.height=m*R;g.style.width=e+"px";g.style.height=m+"px";q.scale(R,R);x.canvas.width=e;x.canvas.height=m;P={};if(n){c(n,function(){j()})}};var G=function(Q){I=true;o.x=Q.clientX;o.y=Q.clientY};var L=function(Q){h=true};var v=function(){h=false};var O=function(Q){o.x=Q.changedTouches[0].clientX;o.y=Q.changedTouches[0].clientY};var s=function(Q){Q.preventDefault()};var K=function(Q){o.force=Q.webkitForce||1};var t=function(){I=true};var f=function(){I=false};var b=function(){var T,S,V,U,Q,R;T=Date.now();S=T-w;w=T;V=y(S);q.clearRect(0,0,e,m);q.fillStyle=u.color;for(U=0;U<p.length;U++){p[U].update(V,S);Q=p[U];q.beginPath();q.arc(Q.position.x,Q.position.y,Q.radius,0,d);q.closePath();q.globalAlpha=Q.opacity;q.fill()}if(!N){E=requestAnimationFrame(b)}};var y=function(Q){var S,U,T,R;if(D===null){if(F.length!==0){D=F[0];F.splice(0,1);switch(D.type){case"showFigure":c(D.image,function(){D.ready=true});break;case"hideFigure":n=null;for(S=0;S<p.length;S++){p[S].setOffset()}break}if(typeof D.easing==="string"){U=D.easing;D.easing=u.animationEasings[U]}}else{return 1}}if(!D.ready){return 1}D.clock+=Q;T=D.clock/D.duration;R=D.easing(T);if(T>=1){j();if(typeof D.callback==="function"){D.callback()}D=null}return R};var r=function(S){var R,Q;for(R=0;R<S.length;R++){if(typeof p[R]==="undefined"){Q=new i(S[R]);p.push(Q)}else{p[R].setPosition(S[R])}}for(R=S.length;R<p.length;R++){p[R].setOffset(S[R])}};var j=function(){for(var Q=0;Q<p.length;Q++){if(p[Q].offscreen){p.splice(Q,1);Q--}}};var c=function(S,T){var Q,R;n=S;R=new Image();R.onload=function(){if(Array.isArray(P[n])){Q=P[n]}else{Q=P[n]=H(R)}r(Q);T()};R.src=n};var H=function(R){var V,T,U,Q,S,W,Z,Y,X;V=1;V=e/R.width;if(m/R.height<V){V=m/R.height}T={width:V*R.width,height:V*R.height};U={x:e/2-T.width/2,y:m/2-T.height/2};x.clearRect(0,0,e,m);x.drawImage(R,U.x,U.y,T.width,T.height);Q=x.getImageData(0,0,e,m).data;S=3;Z=[];for(X=0;X<m;X++){for(Y=0;Y<e;Y++,S+=4){if(Q[S]>127&&Math.random()<u.pointDensity){Z.push({x:Y,y:X})}}}return Z};function i(Q){var R,T,S;R=u.maxParticleRadius-u.minParticleRadius;this.radius=Math.random()*R+u.minParticleRadius;T=u.maxParticleOpacity-u.minParticleOpacity;this.opacity=Math.random()*T+u.minParticleOpacity;this.offscreen=false;switch(Math.floor(Math.random()*4)){case 0:this.offscreenPosition={x:Math.random()*(e+200)-100,y:Math.random()*-80-20};break;case 1:this.offscreenPosition={x:e+(Math.random()*80+20),y:Math.random()*(m+200)-100};break;case 2:this.offscreenPosition={x:Math.random()*(e+200)-100,y:m+(Math.random()*80+20)};break;case 3:this.offscreenPosition={x:Math.random()*-80-20,y:Math.random()*(m+200)-100};break}this.position={x:this.offscreenPosition.x,y:this.offscreenPosition.y};this.previousPosition={x:this.offscreenPosition.x,y:this.offscreenPosition.y};this.nextPosition={x:Q.x,y:Q.y};this.previousTrembleOffset={x:0,y:0};this.nextTrembleOffset={x:0,y:0};this.mouseOffset={x:0,y:0};S=u.maxTrembleDuration-u.minTrembleDuration;this.trembleDuration=Math.random()*S+u.minTrembleDuration;this.trembleClock=u.maxTrembleDuration}i.prototype.setPosition=function(Q){this.previousPosition={x:this.nextPosition.x,y:this.nextPosition.y};this.nextPosition={x:Q.x,y:Q.y}};i.prototype.setOffset=function(){this.previousPosition={x:this.nextPosition.x,y:this.nextPosition.y};this.nextPosition={x:this.offscreenPosition.x,y:this.offscreenPosition.y};this.offscreen=true};i.prototype.update=function(Y,X){var T,S;if(Y<1){T=this.nextPosition.x-this.previousPosition.x;S=this.nextPosition.y-this.previousPosition.y;this.position={x:this.previousPosition.x+(T*Y),y:this.previousPosition.y+(S*Y)}}else{this.position={x:this.nextPosition.x,y:this.nextPosition.y}}var R,Q,aa;if(this.trembleDuration<=this.trembleClock){this.trembleClock=0;this.previousTrembleOffset={x:this.nextTrembleOffset.x,y:this.nextTrembleOffset.y};Q=u.maxTrembleOffset-u.minTrembleOffset;this.nextTrembleOffset={x:Math.random()*Q-u.minTrembleOffset,y:Math.random()*20-10}}T=this.nextTrembleOffset.x-this.previousTrembleOffset.x;S=this.nextTrembleOffset.y-this.previousTrembleOffset.y;this.trembleClock+=X;R=this.trembleClock/this.trembleDuration;aa={x:this.previousTrembleOffset.x+(T*R),y:this.previousTrembleOffset.y+(S*R)};this.position={x:this.position.x+aa.x,y:this.position.y+aa.y};if(!u.pointForceActivated){return}var Z,W,V,U;T=this.position.x-o.x;S=this.position.y-o.y;W=Math.sqrt(Math.pow(T,2)+Math.pow(S,2));if(h&&u.clickedMouseForceActivated){Z=u.clickedMouseForceRadius*o.force}else{Z=u.pointForceRadius}V=Math.abs(this.mouseOffset.x)>0||Math.abs(this.mouseOffset.y)>0;if(!I&&V){this.mouseOffset.x-=this.mouseOffset.x*0.1;this.mouseOffset.y-=this.mouseOffset.y*0.1}else{if(Math.abs(W)<Z){U={x:(T/W*Z)-T,y:(S/W*Z)-S};this.mouseOffset.x+=(U.x-this.mouseOffset.x)*0.1;this.mouseOffset.y+=(U.y-this.mouseOffset.y)*0.1}else{if(V){this.mouseOffset.x-=this.mouseOffset.x*0.1;this.mouseOffset.y-=this.mouseOffset.y*0.1}}}this.position={x:this.position.x+this.mouseOffset.x,y:this.position.y+this.mouseOffset.y}};J()};return a});var NEWTON_ITERATIONS=4;var NEWTON_MIN_SLOPE=0.001;var SUBDIVISION_PRECISION=1e-7;var SUBDIVISION_MAX_ITERATIONS=10;var kSplineTableSize=11;var kSampleStepSize=1/(kSplineTableSize-1);var float32ArraySupported=typeof Float32Array==="function";function A(a,b){return 1-3*b+3*a}function B(a,b){return 3*b-6*a}function C(a){return 3*a}function calcBezier(c,a,b){return((A(a,b)*c+B(a,b))*c+C(a))*c}function getSlope(c,a,b){return 3*A(a,b)*c*c+2*B(a,b)*c+C(a)}function binarySubdivide(e,f,d,h,g){var a,c,b=0;do{c=f+(d-f)/2;a=calcBezier(c,h,g)-e;if(a>0){d=c}else{f=c}}while(Math.abs(a)>SUBDIVISION_PRECISION&&++b<SUBDIVISION_MAX_ITERATIONS);return c}function newtonRaphsonIterate(d,b,g,e){for(var c=0;c<NEWTON_ITERATIONS;++c){var f=getSlope(b,g,e);if(f===0){return b}var a=calcBezier(b,g,e)-d;b-=a/f}return b}window.BezierEasing=function bezier(f,b,e,h){if(!(0<=f&&f<=1&&0<=e&&e<=1)){throw new Error("bezier x values must be in [0, 1] range")}var g=float32ArraySupported?new Float32Array(kSplineTableSize):new Array(kSplineTableSize);if(f!==b||e!==h){for(var d=0;d<kSplineTableSize;++d){g[d]=calcBezier(d*kSampleStepSize,f,e)}}function a(m){var n=0;var l=1;var i=kSplineTableSize-1;for(;l!==i&&g[l]<=m;++l){n+=kSampleStepSize}--l;var o=(m-g[l])/(g[l+1]-g[l]);var k=n+o*kSampleStepSize;var j=getSlope(k,f,e);if(j>=NEWTON_MIN_SLOPE){return newtonRaphsonIterate(m,k,f,e)}else{if(j===0){return k}else{return binarySubdivide(m,n,n+kSampleStepSize,f,e)}}}return function c(i){if(f===b&&e===h){return i}if(i===0){return 0}if(i===1){return 1}return calcBezier(a(i),b,h)}};
