/**
 *
 * @name StrangeOrbits
 *
 * @author Sahithyen Kanaganayagam - @sahithyen
 * @version 1.0.0
 *
 * @description Creates a canvas with figures out of points from an image
 *
 * @license GNU GPL v3
 *
 * Copyright (C) 2015 Sahithyen Kanaganayagam (mail@sahithyen.com)
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see <http://www.gnu.org/licenses/>.
 *
 **/

function A(e,i){return 1-3*i+3*e}function B(e,i){return 3*i-6*e}function C(e){return 3*e}function calcBezier(e,i,t){return((A(i,t)*e+B(i,t))*e+C(i))*e}function getSlope(e,i,t){return 3*A(i,t)*e*e+2*B(i,t)*e+C(i)}function binarySubdivide(e,i,t,n,a){var o,r,s=0;do r=i+(t-i)/2,o=calcBezier(r,n,a)-e,o>0?t=r:i=r;while(Math.abs(o)>SUBDIVISION_PRECISION&&++s<SUBDIVISION_MAX_ITERATIONS);return r}function newtonRaphsonIterate(e,i,t,n){for(var a=0;NEWTON_ITERATIONS>a;++a){var o=getSlope(i,t,n);if(0===o)return i;var r=calcBezier(i,t,n)-e;i-=r/o}return i}!function(e){"use strict";"object"==typeof exports?module.exports=e():"function"==typeof define&&define.amd?define("StrangeOrbits",[],e):window.StrangeOrbits=e()}(function(){"use strict";var e=function(e,i){function t(e){var i,t,o,r,s,c,u,d,l,f,m=function(){var u,y,p;switch(u=h.maxParticleRadius-h.minParticleRadius,this.radius=Math.random()*u+h.minParticleRadius,y=h.maxParticleOpacity-h.minParticleOpacity,this.opacity=Math.random()*y+h.minParticleOpacity,this.offscreen=!1,Math.floor(4*Math.random())){case 0:i={x:Math.random()*(n+200)-100,y:-80*Math.random()-20};break;case 1:i={x:n+(80*Math.random()+20),y:Math.random()*(a+200)-100};break;case 2:i={x:Math.random()*(n+200)-100,y:a+(80*Math.random()+20)};break;case 3:i={x:-80*Math.random()-20,y:Math.random()*(a+200)-100}}this.position={x:i.x,y:i.y},t={x:i.x,y:i.y},o={x:i.x,y:i.y},r={x:e.x,y:e.y},s={x:0,y:0},c={x:0,y:0},d={x:0,y:0},p=h.maxTrembleDuration-h.minTrembleDuration,l=Math.random()*p+h.minTrembleDuration,f=h.maxTrembleDuration}.bind(this);this.setPosition=function(e){t={x:r.x,y:r.y},r={x:e.x,y:e.y}}.bind(this),this.setOffset=function(){t={x:r.x,y:r.y},r={x:i.x,y:i.y},this.offscreen=!0}.bind(this),this.update=function(e,i){if(1>e){var n,a;n=r.x-t.x,o.x=t.x+n*e,a=r.y-t.y,o.y=t.y+a*e,this.position={x:o.x,y:o.y}}else this.position={x:r.x,y:r.y};b(i),this.position={x:this.position.x+u.x,y:this.position.y+u.y},h.pointForceActivated&&(g(),this.position={x:this.position.x+d.x,y:this.position.y+d.y})}.bind(this);var b=function(e){var i,t,n,a;f>=l&&(f=0,s={x:c.x,y:c.y},a=h.maxTrembleOffset-h.minTrembleOffset,c={x:Math.random()*a-h.minTrembleOffset,y:20*Math.random()-10}),t=c.x-s.x,n=c.y-s.y,f+=e,i=f/l,u={x:s.x+t*i,y:s.y+n*i}}.bind(this),g=function(){var e,i,t,n,a,o;e=this.position.x-y.x,i=this.position.y-y.y,n=Math.sqrt(Math.pow(e,2)+Math.pow(i,2)),t=p&&h.clickedMouseForceActivated?h.clickedMouseForceRadius:h.pointForceRadius,a=Math.abs(d.x)>0||Math.abs(d.y)>0,!x&&a?(d.x-=.1*d.x,d.y-=.1*d.y):Math.abs(n)<t?(o={x:e/n*t-e,y:i/n*t-i},d.x+=.1*(o.x-d.x),d.y+=.1*(o.y-d.y)):a&&(d.x-=.1*d.x,d.y-=.1*d.y)}.bind(this);m()}var n,a,o,r,s,c,u,d,h,l=2*Math.PI,f=!0,y={x:null,y:null},p=!1,x=!1,m=[],b=[],g=null,S=null;this.options=h={color:"#FFFFFF",pointDensity:.0075,minParticleRadius:1,maxParticleRadius:3,minParticleOpacity:.15,maxParticleOpacity:.85,minTrembleOffset:10,maxTrembleOffset:20,minTrembleDuration:250,maxTrembleDuration:750,pointForceActivated:!0,pointForceRadius:60,clickedMouseForceActivated:!0,clickedMouseForceRadius:90,animationEasings:{ease:new BezierEasing(.25,.1,.25,1),linear:new BezierEasing(0,0,1,1),"ease-in":new BezierEasing(.42,0,1,1),"ease-out":new BezierEasing(0,0,.58,1),"ease-in-out":new BezierEasing(.42,0,.58,1),strange:new BezierEasing(.7,0,.3,1)}},h.__defineGetter__("backgroundColor",function(){return e.style.backgroundColor}),h.__defineSetter__("backgroundColor",function(i){e.style.backgroundColor=i});var v=function(){if(o=document.createElement("canvas"),e.appendChild(o),r=o.getContext("2d"),s=document.createElement("canvas"),c=s.getContext("2d"),h.backgroundColor="#080808","object"==typeof i)for(var t in i)h[t]=i[t];w(),window.addEventListener("resize",w),e.addEventListener("mousemove",k),e.addEventListener("mousedown",E),e.addEventListener("mouseup",I),e.addEventListener("touchstart",O),e.addEventListener("touchmove",M),e.addEventListener("touchend",T),e.addEventListener("touchcancel",T)}.bind(this);this.start=function(){f=!1,u=Date.now(),d=requestAnimationFrame(z)},this.stop=function(){f=!0},this.showFigure=function(e,i,t,n){b.push({type:"showFigure",clock:0,ready:!1,duration:i,easing:"undefined"==typeof t?"strange":t,callback:n,properties:{url:e}})},this.hideFigure=function(e,i,t){b.push({type:"hideFigure",clock:0,ready:!0,duration:e,easing:"undefined"==typeof i?"strange":i,callback:t})}.bind(this);var w=function(){n=e.offsetWidth,a=e.offsetHeight;var i=window.devicePixelRatio||1,t=r.webkitBackingStorePixelRatio||r.mozBackingStorePixelRatio||r.msBackingStorePixelRatio||r.oBackingStorePixelRatio||r.backingStorePixelRatio||1,s=i/t;o.width=n*s,o.height=a*s,o.style.width=n+"px",o.style.height=a+"px",r.scale(s,s),c.canvas.width=n,c.canvas.height=a,null!==S&&R(S,function(){N()}.bind(this))}.bind(this),k=function(e){x=!0,y.x=e.clientX,y.y=e.clientY}.bind(this),E=function(){p=!0}.bind(this),I=function(){p=!1}.bind(this),M=function(e){y.x=e.changedTouches[0].clientX,y.y=e.changedTouches[0].clientY}.bind(this),O=function(){x=!0}.bind(this),T=function(){x=!1}.bind(this),z=function(){var e,i,t,o,s;for(e=Date.now(),i=e-u,u=e,t=P(i),r.clearRect(0,0,n,a),r.fillStyle=h.color,o=0;o<m.length;o++)m[o].update(t,i),s=m[o],r.beginPath(),r.arc(s.position.x,s.position.y,s.radius,0,l),r.closePath(),r.globalAlpha=s.opacity,r.fill();f||(d=requestAnimationFrame(z))}.bind(this),P=function(e){var i,t,n,a;if(null===g){if(0===b.length)return 1;switch(g=b[0],b.splice(0,1),g.type){case"showFigure":R(g.properties.url,function(){g.ready=!0}.bind(this));break;case"hideFigure":for(S=null,i=0;i<m.length;i++)m[i].setOffset()}"string"==typeof g.easing&&(t=g.easing,g.easing=h.animationEasings[t])}return g.ready?(g.clock+=e,n=g.clock/g.duration,a=g.easing(n),n>=1&&(N(),"function"==typeof g.callback&&g.callback(),g=null),a):1}.bind(this),R=function(e,i){F(e,function(e){var t;t=B(e),A(t,i)}.bind(this))}.bind(this),F=function(e,i){var t;t=new Image,t.onload=function(){"function"==typeof i&&i(t)}.bind(this),S=t.src=e}.bind(this),B=function(e){var i,t,o,r;return t=1,i={width:e.width,height:e.height},t=n/i.width,a/i.height<t&&(t=a/i.height),i={width:t*i.width,height:t*i.height},o={x:n/2-i.width/2,y:a/2-i.height/2},c.clearRect(0,0,n,a),c.drawImage(e,o.x,o.y,i.width,i.height),r=c.getImageData(0,0,n,a),r.data}.bind(this),A=function(e,i){var o,r,s,c,u,d;for(o=3,r=0,c=0;a>c;c++)for(s=0;n>s;s++,o+=4)e[o]>127&&Math.random()<h.pointDensity&&(u={x:s,y:c},"undefined"!=typeof m[r]?m[r].setPosition(u):(d=new t(u),m.push(d)),r++);for(o=r;o<m.length;o++)m[o].setOffset();"function"==typeof i&&i()}.bind(this),N=function(){for(var e=0;e<m.length;e++)m[e].offscreen&&(m.splice(e,1),e--)}.bind(this);v()};return e});var NEWTON_ITERATIONS=4,NEWTON_MIN_SLOPE=.001,SUBDIVISION_PRECISION=1e-7,SUBDIVISION_MAX_ITERATIONS=10,kSplineTableSize=11,kSampleStepSize=1/(kSplineTableSize-1),float32ArraySupported="function"==typeof Float32Array;window.BezierEasing=function(e,i,t,n){function a(i){for(var n=0,a=1,r=kSplineTableSize-1;a!==r&&o[a]<=i;++a)n+=kSampleStepSize;--a;var s=(i-o[a])/(o[a+1]-o[a]),c=n+s*kSampleStepSize,u=getSlope(c,e,t);return u>=NEWTON_MIN_SLOPE?newtonRaphsonIterate(i,c,e,t):0===u?c:binarySubdivide(i,n,n+kSampleStepSize,e,t)}if(!(e>=0&&1>=e&&t>=0&&1>=t))throw new Error("bezier x values must be in [0, 1] range");var o=float32ArraySupported?new Float32Array(kSplineTableSize):new Array(kSplineTableSize);if(e!==i||t!==n)for(var r=0;kSplineTableSize>r;++r)o[r]=calcBezier(r*kSampleStepSize,e,t);return function(o){return e===i&&t===n?o:0===o?0:1===o?1:calcBezier(a(o),i,n)}};
